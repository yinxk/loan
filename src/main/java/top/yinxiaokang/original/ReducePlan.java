package top.yinxiaokang.original;

import top.yinxiaokang.others.ReducePlanEntity;

import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author yinxk
 * @date 2018/7/6 14:11
 */
public class ReducePlan {

    public static void main(String[] args)  {
        long startTime = System.currentTimeMillis();
        Conn conn = new Conn();
        Connection connection = conn.getConnection();
        PreparedStatement preparedStatement = null;
        ResultSet resultSet = null;

        ReducePlan reducePlan = new ReducePlan();

        try {


            List<ReducePlanEntity> reducePlanEntityList = reducePlan.getLoan2(connection, preparedStatement, resultSet);
            BigDecimal bigDecimal = null;
            BigDecimal currentBX = null;
            BigDecimal overdueThisPeriodLX = null;
            BigDecimal bjje = null;
            int count = 0 ;
            for (ReducePlanEntity entity : reducePlanEntityList) {
                String id = entity.getId();
                BigDecimal dkll = entity.getDkll();
                BigDecimal llfdbl = entity.getLlfdbl();

                BigDecimal dkgbjhqs = entity.getDkgbjhqs();
                BigDecimal dkgbjhye = entity.getDkgbjhye();
                BigDecimal dqqc = entity.getDqqc();

                String dkhkfs = entity.getDkhkfs();
                if (dkgbjhqs.compareTo(BigDecimal.ZERO) > 0) {
                    bigDecimal = CommLoanAlgorithm.lendingRate(dkll, llfdbl);
                    currentBX = CommLoanAlgorithm.currentBX(dkgbjhye, Integer.parseInt(dkgbjhqs.toString()), dkhkfs, bigDecimal, Integer.parseInt(dqqc.toString())).setScale(2, BigDecimal.ROUND_HALF_UP);
                    overdueThisPeriodLX = CommLoanAlgorithm.overdueThisPeriodLX(dkgbjhye, Integer.parseInt(dqqc.toString()), dkhkfs, bigDecimal, Integer.parseInt(dkgbjhqs.toString())).setScale(2, BigDecimal.ROUND_HALF_UP);
                    bjje = currentBX.subtract(overdueThisPeriodLX);

                    int i = reducePlan.updateLoanAccountPlan(connection, currentBX,  bjje, overdueThisPeriodLX,id);
                    if (i > 0){
                        count ++;
                        System.out.println("更新了id为: " + id + " 的记录  ");
                    }
                }
            }

            System.out.println("总共更新的记录数:" + count);
            long endTime = System.currentTimeMillis();
            System.out.println("正常结束，时间："+(endTime - startTime) + " ms");
        }catch (Exception e){
            e.printStackTrace();
            conn.closeResource(connection,preparedStatement,resultSet);
        }finally {
            conn.closeResource(connection,preparedStatement,resultSet);
        }


    }


    public List<ReducePlanEntity> getLoan2(Connection connection,PreparedStatement preparedStatement,ResultSet resultSet) throws SQLException {
        String dkzhs = "'52001069403600000000582147',\n" +
                "        '52001069403600000000631592',\n" +
                "        '52001069403600000000582155',\n" +
                "        '52001069403600000000603966',\n" +
                "        '52001069008800000000643622',\n" +
                "        '52001069403600000000568983',\n" +
                "        '52001069403600000000625624',\n" +
                "        '52001069403600000000596497',\n" +
                "        '52001069403600000000603991',\n" +
                "        '52001069403600000000532951',\n" +
                "        '52001069403600000000614877',\n" +
                "        '52001069403600000000623894',\n" +
                "        '52001069403600000000568988',\n" +
                "        '52001069403600000000582226',\n" +
                "        '52001069403600000000569067',\n" +
                "        '52001069403600000000604666',\n" +
                "        '52001069403600000000624521',\n" +
                "        '52001069403600000000575290',\n" +
                "        '52001069403600000000532634',\n" +
                "        '52001069403600000000596680',\n" +
                "        '52001069403600000000615885',\n" +
                "        '52001069403600000000604248',\n" +
                "        '52001069403600000000604015',\n" +
                "        '52001069403600000000568501',\n" +
                "        '52001069403600000000632176',\n" +
                "        '52001069403600000000605154',\n" +
                "        '52001069403600000000605108',\n" +
                "        '52001069403600000000604755',\n" +
                "        '52001069008800000000632631',\n" +
                "        '52001069403600000000603962',\n" +
                "        '52001069403600000000533767',\n" +
                "        '52001069403600000000604669',\n" +
                "        '52001069403600000000533133',\n" +
                "        '52001069403600000000533122',\n" +
                "        '52001069403600000000603968',\n" +
                "        '52001069403600000000632170',\n" +
                "        '52001069403600000000603963',\n" +
                "        '52001069403600000000582151',\n" +
                "        '52001069403600000000604260',\n" +
                "        '52001069403600000000533127',\n" +
                "        '52001069008800000000643639',\n" +
                "        '52001069403600000000615788',\n" +
                "        '52001069403600000000614726',\n" +
                "        '52001069403600000000569064',\n" +
                "        '52001069403600000000553614',\n" +
                "        '52001069008800000000645509',\n" +
                "        '52001069403600000000595913',\n" +
                "        '52001069403600000000615105',\n" +
                "        '52001069403600000000596368',\n" +
                "        '52001069403600000000623887',\n" +
                "        '52001069403600000000604760',\n" +
                "        '52001069403600000000615428',\n" +
                "        '52001069403600000000614873',\n" +
                "        '52001069403600000000625674',\n" +
                "        '52001069403600000000604672',\n" +
                "        '52001069403600000000604246',\n" +
                "        '52001069403600000000567721',\n" +
                "        '52001069403600000000569140',\n" +
                "        '52001069403600000000595907',\n" +
                "        '52001069403600000000623899',\n" +
                "        '52001069403600000000615277',\n" +
                "        '52001069403600000000631967',\n" +
                "        '52001069403600000000581407',\n" +
                "        '52001069403600000000605064',\n" +
                "        '52001069403600000000582149',\n" +
                "        '52001069403600000000596484',\n" +
                "        '52001069403600000000561247',\n" +
                "        '52001069403600000000569137',\n" +
                "        '52001069403600000000631540',\n" +
                "        '52001069008800000000666577',\n" +
                "        '52001069403600000000615857',\n" +
                "        '52001069403600000000532943',\n" +
                "        '52001069403600000000604474',\n" +
                "        '52001069403600000000604010',\n" +
                "        '52001069008800000000654673',\n" +
                "        '52001069403600000000596367',\n" +
                "        '52001069403600000000569146',\n" +
                "        '52001069403600000000616336',\n" +
                "        '52001069008800000000655845',\n" +
                "        '52001069008800000000655839',\n" +
                "        '52001069403600000000533132',\n" +
                "        '52001069403600000000533115',\n" +
                "        '52001069403600000000615776',\n" +
                "        '52001069403600000000615781',\n" +
                "        '52001069008800000000655844',\n" +
                "        '52001069403600000000553618',\n" +
                "        '52001069403600000000532625',\n" +
                "        '52001069403600000000603588',\n" +
                "        '52001069403600000000582897',\n" +
                "        '52001069403600000000624531',\n" +
                "        '52001069403600000000624578',\n" +
                "        '52001069403600000000532953',\n" +
                "        '52001069403600000000603591',\n" +
                "        '52001069403600000000605114',\n" +
                "        '52001069403600000000616345',\n" +
                "        '52001069403600000000615432',\n" +
                "        '52001069403600000000604681',\n" +
                "        '52001069403600000000632155',\n" +
                "        '52001069403600000000533105',\n" +
                "        '52001069403600000000624526',\n" +
                "        '52001069403600000000534668',\n" +
                "        '52001069403600000000605120',\n" +
                "        '52001069403600000000568920',\n" +
                "        '52001069403600000000568500',\n" +
                "        '52001069403600000000616361',\n" +
                "        '52001069403600000000561259',\n" +
                "        '52001069403600000000596383',\n" +
                "        '52001069403600000000568917',\n" +
                "        '52001069403600000000603996',\n" +
                "        '52001069403600000000575259',\n" +
                "        '52001069403600000000604701',\n" +
                "        '52001069403600000000605118',\n" +
                "        '52001069403600000000632199',\n" +
                "        '52001069403600000000603967',\n" +
                "        '52001069403600000000623892',\n" +
                "        '52001069403600000000605117',\n" +
                "        '52001069008800000000643691',\n" +
                "        '52001069403600000000568985',\n" +
                "        '52001069403600000000575289',\n" +
                "        '52001069403600000000603971',\n" +
                "        '52001069403600000000624246',\n" +
                "        '52001069403600000000615775',\n" +
                "        '52001069403600000000625636',\n" +
                "        '52001069403600000000532928',\n" +
                "        '52001069403600000000604050',\n" +
                "        '52001069403600000000616351',\n" +
                "        '52001069403600000000614664',\n" +
                "        '52001069403600000000614857',\n" +
                "        '52001069403600000000615135',\n" +
                "        '52001069403600000000631576',\n" +
                "        '52001069403600000000567809',\n" +
                "        '52001069403600000000605116',\n" +
                "        '52001069008800000000654836',\n" +
                "        '52001069403600000000561264',\n" +
                "        '52001069403600000000615856',\n" +
                "        '52001069403600000000553511',\n" +
                "        '52001069403600000000615430',\n" +
                "        '52001069403600000000604679',\n" +
                "        '52001069403600000000625810',\n" +
                "        '52001069403600000000631571',\n" +
                "        '52001069403600000000604671',\n" +
                "        '52001069403600000000616302',\n" +
                "        '52001069403600000000561251',\n" +
                "        '52001069403600000000568916',\n" +
                "        '52001069403600000000596495',\n" +
                "        '52001069403600000000625632',\n" +
                "        '52001069403600000000582904',\n" +
                "        '52001069403600000000615768',\n" +
                "        '52001069403600000000569074',\n" +
                "        '52001069403600000000614890',\n" +
                "        '52001069403600000000625614',\n" +
                "        '52001069008800000000644649',\n" +
                "        '52001069403600000000615274',\n" +
                "        '52001069008800000000632648',\n" +
                "        '52001069403600000000604667',\n" +
                "        '52001069403600000000604250',\n" +
                "        '52001069403600000000632182',\n" +
                "        '52001069403600000000615852',\n" +
                "        '52001069403600000000533113',\n" +
                "        '52001069403600000000603585',\n" +
                "        '52001069403600000000569129',\n" +
                "        '52001069403600000000615888',\n" +
                "        '52001069403600000000605065',\n" +
                "        '52001069403600000000615286',\n" +
                "        '52001069403600000000616334',\n" +
                "        '52001069403600000000532932',\n" +
                "        '52001069403600000000568990',\n" +
                "        '52001069403600000000532938',\n" +
                "        '52001069403600000000569132',\n" +
                "        '52001069008800000000643620',\n" +
                "        '52001069403600000000632193',\n" +
                "        '52001069403600000000604047',\n" +
                "        '52001069403600000000631566',\n" +
                "        '52001069403600000000533134',\n" +
                "        '52001069403600000000568904',\n" +
                "        '52001069403600000000532935',\n" +
                "        '52001069403600000000604751',\n" +
                "        '52001069403600000000568452',\n" +
                "        '52001069403600000000596490',\n" +
                "        '52001069403600000000603965',\n" +
                "        '52001069403600000000569135',\n" +
                "        '52001069403600000000604477',\n" +
                "        '52001069403600000000626226',\n" +
                "        '52001069008800000000655830',\n" +
                "        '52001069403600000000615130',\n" +
                "        '52001069403600000000605115',\n" +
                "        '52001069403600000000533109',\n" +
                "        '52001069403600000000532868',\n" +
                "        '52001069403600000000605245',\n" +
                "        '52001069008800000000645135',\n" +
                "        '52001069008800000000655849',\n" +
                "        '52001069008800000000645507',\n" +
                "        '52001069403600000000623869',\n" +
                "        '52001069403600000000615862',\n" +
                "        '52001069403600000000625618',\n" +
                "        '52001069403600000000631482',\n" +
                "        '52001069403600000000568895',\n" +
                "        '52001069403600000000604680',\n" +
                "        '52001069403600000000626142',\n" +
                "        '52001069403600000000631562',\n" +
                "        '52001069403600000000632121',\n" +
                "        '52001069403600000000567726',\n" +
                "        '52001069403600000000616554',\n" +
                "        '52001069403600000000616140',\n" +
                "        '52001069403600000000614739',\n" +
                "        '52001069403600000000568915',\n" +
                "        '52001069403600000000624512',\n" +
                "        '52001069403600000000533099',\n" +
                "        '52001069403600000000568923',\n" +
                "        '52001069403600000000582899',\n" +
                "        '52001069403600000000569053',\n" +
                "        '52001069403600000000624243',\n" +
                "        '52001069403600000000604005',\n" +
                "        '52001069403600000000581406',\n" +
                "        '52001069403600000000596366',\n" +
                "        '52001069403600000000623903',\n" +
                "        '52001069403600000000624568',\n" +
                "        '52001069403600000000604254',\n" +
                "        '52001069403600000000533120',\n" +
                "        '52001069403600000000604673',\n" +
                "        '52001069403600000000616338',\n" +
                "        '52001069403600000000596492',\n" +
                "        '52001069403600000000615779',\n" +
                "        '52001069403600000000603976',\n" +
                "        '52001069403600000000624606',\n" +
                "        '52001069403600000000533131',\n" +
                "        '52001069403600000000604018',\n" +
                "        '52001069403600000000603586',\n" +
                "        '52001069008800000000643648',\n" +
                "        '52001069403600000000631982',\n" +
                "        '52001069403600000000605078',\n" +
                "        '52001069403600000000615853',\n" +
                "        '52001069403600000000569148',\n" +
                "        '52001069403600000000624951',\n" +
                "        '52001069403600000000632196',\n" +
                "        '52001069403600000000568989',\n" +
                "        '52001069008800000000655835',\n" +
                "        '52001069403600000000614797',\n" +
                "        '52001069403600000000596332',\n" +
                "        '52001069008800000000655846',\n" +
                "        '52001069008800000000645510',\n" +
                "        '52001069403600000000615142',\n" +
                "        '52001069403600000000604467',\n" +
                "        '52001069403600000000615087',\n" +
                "        '52001069403600000000604249',\n" +
                "        '52001069008800000000644652',\n" +
                "        '52001069403600000000568922',\n" +
                "        '52001069403600000000568929',\n" +
                "        '52001069403600000000596334',\n" +
                "        '52001069403600000000568931',\n" +
                "        '52001069403600000000567806',\n" +
                "        '52001069403600000000568449',\n" +
                "        '52001069403600000000625620',\n" +
                "        '52001069403600000000603982',\n" +
                "        '52001069403600000000614659',\n" +
                "        '52001069403600000000631547',\n" +
                "        '52001069403600000000615109'";

        String selectSql = "SELECT\n" +
                "\taccount.id,\n" +
                "\taccount.dkll,\n" +
                "\taccount.llfdbl,\n" +
                "\tex.dkgbjhqs,\n" +
                "\tex.dkgbjhye,\n" +
                "\tex.dqqc,\n" +
                "\tpersonalLoan.dkhkfs\n" +
                "FROM\n" +
                "\tst_housing_personal_account account\n" +
                "JOIN c_loan_housing_personal_account_extension ex on account.extenstion =ex.id\n" +
                "JOIN st_housing_personal_loan personalLoan on account.contract = personalLoan.id\n" +
                "JOIN c_loan_housing_person_information_basic basic on basic.personalAccount = account.id " +
                "WHERE \n" +
                "\t basic.dkzhzt IN ('2', '3', '5')\n" +
                "AND basic.dkzh IN (\n" +dkzhs +
                ")\n ";

        preparedStatement = connection.prepareStatement(selectSql);
        resultSet = preparedStatement.executeQuery();
        List<ReducePlanEntity> reducePlanEntityList = new ArrayList<>();
        while (resultSet.next()) {
            ReducePlanEntity reducePlanEntity = new ReducePlanEntity();
            String id = resultSet.getString("id");
            BigDecimal dkll = resultSet.getBigDecimal("dkll");
            BigDecimal llfdbl = resultSet.getBigDecimal("llfdbl");
            BigDecimal dkgbjhqs = resultSet.getBigDecimal("dkgbjhqs");
            BigDecimal dkgbjhye = resultSet.getBigDecimal("dkgbjhye");
            BigDecimal dqqc = resultSet.getBigDecimal("dqqc");
            String dkhkfs= resultSet.getString("dkhkfs");
            reducePlanEntity.setId(id);
            reducePlanEntity.setDkll(dkll);
            reducePlanEntity.setLlfdbl(llfdbl);
            reducePlanEntity.setDkgbjhqs(dkgbjhqs);
            reducePlanEntity.setDkgbjhye(dkgbjhye);
            reducePlanEntity.setDqqc(dqqc);
            reducePlanEntity.setDkhkfs(dkhkfs);
            reducePlanEntityList.add(reducePlanEntity);
        }
        return reducePlanEntityList;
    }

    public int updateLoanAccountPlan(Connection connection,BigDecimal dqyhje,BigDecimal dqyhbj,BigDecimal dqyhlx,String id) throws SQLException {
        String sql = "update st_housing_personal_account set " +
                "DQYHJE = ? " +
                ", DQYHBJ = ?" +
                ", DQYHLX = ? " +
                ", DQJHHKJE = ?" +
                ", DQJHGHLX = ?" +
                ", DQJHGHBJ = ? " +
                ", updated_at = now() " +
                "where id = ?";

        PreparedStatement preparedStatement = connection.prepareStatement(sql);
        preparedStatement.setBigDecimal(1,dqyhje);
        preparedStatement.setBigDecimal(2, dqyhbj);
        preparedStatement.setBigDecimal(3, dqyhlx);
        preparedStatement.setBigDecimal(4,dqyhje);
        preparedStatement.setBigDecimal(5, dqyhlx);
        preparedStatement.setBigDecimal(6, dqyhbj);

        preparedStatement.setString(7, id);
        return preparedStatement.executeUpdate();
    }
}
